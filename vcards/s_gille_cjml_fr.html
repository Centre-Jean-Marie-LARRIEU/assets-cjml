<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact - Sébastien GILLE</title>
    <link rel="icon" href="https://Centre-Jean-Marie-LARRIEU.github.io/assets-cjml/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... (Votre CSS existant ici, inchangé) ... */
    </style>
    <script>
        // --- SCRIPT DE GESTION DU CONSENTEMENT ET GOOGLE ANALYTICS ---
        const GA4_MEASUREMENT_ID = 'G-2MWWE56469'; // VOTRE ID GA4

        // Définir dataLayer et la fonction gtag globalement et très tôt
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}

        // Initialisation de base (pour les commandes qui doivent être en file d'attente tôt)
        gtag('js', new Date());

        // Définir 'card_user_name' comme un paramètre global pour tous les hits suivants
        // Placé ici, il sera mis en file d'attente et appliqué à tous les événements dès que gtag.js est prêt.
        gtag('set', { 'card_user_name': 'Sébastien GILLE' });

        // Fonction pour envoyer des événements GA (plus robuste)
        function sendGAEvent(command, ...args) {
            // Puisque gtag est défini très tôt (même si le script complet n'est pas chargé),
            // il mettra les commandes en file d'attente dans dataLayer.
            gtag(command, ...args);
            console.log(`GA command sent: ${command}`, args);
        }

        function initializeGoogleAnalytics() {
            if (window.gaInitialized) return; 

            const gtagScript = document.createElement('script');
            gtagScript.async = true;
            gtagScript.src = `https://www.googletagmanager.com/gtag/js?id=${GA4_MEASUREMENT_ID}`;
            
            // Exécuter les commandes de configuration après le chargement du script gtag.js
            gtagScript.onload = () => { 
                sendGAEvent('config', GA4_MEASUREMENT_ID);
                console.log('Google Analytics initialisé.');

                // Déclenchement des écouteurs d'événements GA4 APRÈS INITIALISATION ET DOM READY
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', setupGAEventListeners);
                } else {
                    setupGAEventListeners();
                }
            };
            document.head.appendChild(gtagScript); // Ajout du script au DOM

            window.gaInitialized = true; 
        }

        function setupGAEventListeners() {
            const userName = 'Sébastien GILLE'; // Toujours là pour les labels spécifiques aux boutons

            function sendButtonClickEvent(category, label, text) {
                sendGAEvent('event', 'button_click', {
                    'event_category': category,
                    'event_label': label + ' - ' + userName, // 'userName' est déjà dans event_label
                    'button_text': text
                    // card_user_name n'est plus ajouté ici car il est globalement 'set'
                });
                console.log('GA Event Queued (via sendGAEvent): ', category, label, text);
            }

            // ... (Le reste de vos attachements d'écouteurs d'événements est inchangé) ...
            document.getElementById('saveContactButton')?.addEventListener('click', function() {
                sendButtonClickEvent('Carte de Visite', 'Enregistrer Contact', 'Enregistrer dans mes Contacts');
            });
            document.getElementById('qrCodeSmallButton')?.addEventListener('click', function() {
                sendButtonClickEvent('Carte de Visite', 'Afficher QR Code', 'Scannez ma carte');
            });
            document.getElementById('shareButton')?.addEventListener('click', function() {
                sendButtonClickEvent('Carte de Visite', 'Ouvrir Partage', 'Partager');
            });
            document.getElementById('qrOverlayLinkButton')?.addEventListener('click', function() {
                sendButtonClickEvent('Carte de Visite', 'Lien Page Complete QR Overlay', 'Accéder à la page complète');
            });
            document.getElementById('nativeShareButton')?.addEventListener('click', function() {
                sendButtonClickEvent('Carte de Visite', 'Partager Natif', 'Partager (appareil)');
            });
            document.getElementById('emailShareButton')?.addEventListener('click', function() {
                sendButtonClickEvent('Carte de Visite', 'Partager Email', 'Envoyer par Email');
            });
            document.getElementById('copyLinkShareButton')?.addEventListener('click', function() {
                sendButtonClickEvent('Carte de Visite', 'Copier Lien Partage', 'Copier le lien');
            });

            const actionButtonsContainer = document.getElementById('actionButtonsContainer');
            if (actionButtonsContainer) {
                actionButtonsContainer.querySelectorAll('a.button, button.button').forEach(button => {
                    const buttonText = button.textContent.trim() || button.getAttribute('data-analytics-label') || 'Action Button';
                    button.addEventListener('click', function() {
                        sendButtonClickEvent('Carte de Visite - Actions', buttonText, buttonText);
                    });
                });
            }
            console.log('Écouteurs d\'événements GA attachés.');
        }

        // --- GESTION DU BANDEAU DE CONSENTEMENT ---
        document.addEventListener('DOMContentLoaded', function() {
            const consentBanner = document.getElementById('cookieConsentBanner');
            const acceptButton = document.getElementById('acceptCookies');
            const denyButton = document.getElementById('denyCookies');
            const consentCookieName = 'cjml_ga_consent';

            const getConsent = () => localStorage.getItem(consentCookieName);

            if (!getConsent()) {
                setTimeout(() => {
                    consentBanner.classList.add('show');
                }, 500); 
            } else if (getConsent() === 'granted') {
                initializeGoogleAnalytics();
            }

            acceptButton.addEventListener('click', function() {
                localStorage.setItem(consentCookieName, 'granted');
                consentBanner.classList.remove('show');
                initializeGoogleAnalytics();
            });

            denyButton.addEventListener('click', function() {
                localStorage.setItem(consentCookieName, 'denied');
                consentBanner.classList.remove('show');
            });
        });
    </script>
</body>
</html>